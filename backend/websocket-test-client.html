<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test Client - CementAI Backend</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            font-weight: bold;
        }
        .connected { 
            background-color: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb;
        }
        .disconnected { 
            background-color: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb;
        }
        .connecting { 
            background-color: #fff3cd; 
            color: #856404; 
            border: 1px solid #ffeaa7;
        }
        .log { 
            background-color: #f8f9fa; 
            border: 1px solid #dee2e6; 
            padding: 15px; 
            height: 300px; 
            overflow-y: auto; 
            font-family: monospace; 
            font-size: 12px;
            white-space: pre-wrap;
        }
        button { 
            background-color: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            margin: 5px; 
            border-radius: 4px; 
            cursor: pointer;
        }
        button:hover { 
            background-color: #0056b3; 
        }
        button:disabled { 
            background-color: #6c757d; 
            cursor: not-allowed;
        }
        input { 
            padding: 8px; 
            margin: 5px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            width: 300px;
        }
        .data-display {
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîå WebSocket Test Client - CementAI Backend</h1>
        
        <div id="status" class="status disconnected">
            ‚ùå Disconnected
        </div>

        <div>
            <label for="serverUrl">Server URL:</label>
            <input type="text" id="serverUrl" value="https://backend2-0-lrcn.onrender.com" placeholder="Enter server URL">
            <button onclick="connect()">Connect</button>
            <button onclick="disconnect()">Disconnect</button>
        </div>

        <div>
            <button onclick="requestSensorData()" disabled id="sensorBtn">Request Sensor Data</button>
            <button onclick="requestProcessData()" disabled id="processBtn">Request Process Data</button>
            <button onclick="clearLog()">Clear Log</button>
        </div>

        <h3>üìä Latest Dashboard Data:</h3>
        <div id="dashboardData" class="data-display">
            No data received yet...
        </div>

        <h3>üìù Connection Log:</h3>
        <div id="log" class="log">WebSocket Test Client Initialized
Ready to connect to CementAI Backend...

</div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        let socket = null;
        let connectionAttempts = 0;
        const maxRetries = 5;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('log');
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStatus(status, message) {
            const statusElement = document.getElementById('status');
            statusElement.className = `status ${status}`;
            statusElement.textContent = message;
        }

        function updateButtons(connected) {
            document.getElementById('sensorBtn').disabled = !connected;
            document.getElementById('processBtn').disabled = !connected;
        }

        function connect() {
            const serverUrl = document.getElementById('serverUrl').value;
            
            if (socket && socket.connected) {
                log('Already connected to server', 'warning');
                return;
            }

            connectionAttempts++;
            log(`Attempting to connect to: ${serverUrl} (Attempt ${connectionAttempts}/${maxRetries})`);
            updateStatus('connecting', 'üîÑ Connecting...');

            try {
                socket = io(serverUrl, {
                    transports: ['websocket', 'polling'],
                    upgrade: true,
                    secure: true,
                    autoConnect: true,
                    reconnection: true,
                    reconnectionAttempts: maxRetries,
                    reconnectionDelay: 1000,
                    reconnectionDelayMax: 5000,
                    timeout: 20000,
                    forceNew: true
                });

                // Connection successful
                socket.on('connect', () => {
                    log(`Connected successfully! Socket ID: ${socket.id}`, 'success');
                    log(`Transport: ${socket.io.engine.transport.name}`, 'success');
                    updateStatus('connected', '‚úÖ Connected');
                    updateButtons(true);
                    connectionAttempts = 0;
                });

                // Connection error
                socket.on('connect_error', (error) => {
                    log(`Connection failed: ${error.message}`, 'error');
                    log(`Error type: ${error.type || 'Unknown'}`, 'error');
                    log(`Error description: ${error.description || 'No description'}`, 'error');
                    updateStatus('disconnected', '‚ùå Connection Failed');
                    updateButtons(false);
                    
                    if (connectionAttempts >= maxRetries) {
                        log(`Max connection attempts (${maxRetries}) reached. Stopping...`, 'error');
                    }
                });

                // Disconnection
                socket.on('disconnect', (reason) => {
                    log(`Disconnected: ${reason}`, 'warning');
                    updateStatus('disconnected', '‚ùå Disconnected');
                    updateButtons(false);
                });

                // Dashboard data updates
                socket.on('dashboard_update', (data) => {
                    log('Received dashboard update', 'success');
                    displayDashboardData(data);
                });

                // Sensor data response
                socket.on('sensor_data', (data) => {
                    log('Received sensor data response', 'success');
                    displaySensorData(data);
                });

                // Process data response
                socket.on('process_data', (data) => {
                    log('Received process data response', 'success');
                    displayProcessData(data);
                });

                // Transport upgrade
                socket.io.engine.on('upgrade', () => {
                    log(`Transport upgraded to: ${socket.io.engine.transport.name}`, 'success');
                });

                // Transport error
                socket.io.engine.on('upgradeError', (error) => {
                    log(`Transport upgrade error: ${error.message}`, 'error');
                });

            } catch (error) {
                log(`Failed to initialize socket: ${error.message}`, 'error');
                updateStatus('disconnected', '‚ùå Initialization Failed');
                updateButtons(false);
            }
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                log('Manually disconnected from server', 'info');
                updateStatus('disconnected', '‚ùå Disconnected');
                updateButtons(false);
            }
        }

        function requestSensorData() {
            if (socket && socket.connected) {
                socket.emit('request_sensor_data');
                log('Requested sensor data from server', 'info');
            } else {
                log('Cannot request data - not connected', 'error');
            }
        }

        function requestProcessData() {
            if (socket && socket.connected) {
                socket.emit('request_process_data');
                log('Requested process data from server', 'info');
            } else {
                log('Cannot request data - not connected', 'error');
            }
        }

        function displayDashboardData(data) {
            const element = document.getElementById('dashboardData');
            element.innerHTML = `
                <strong>Last Update:</strong> ${new Date().toLocaleTimeString()}<br>
                <strong>Plant Overview:</strong><br>
                - Efficiency: ${data.plant_overview?.overall_efficiency || 'N/A'}%<br>
                - Production Rate: ${data.plant_overview?.production_rate_current || 'N/A'} TPH<br>
                - Active Alerts: ${data.plant_overview?.active_alerts_count || 0}<br>
                <strong>Sensors:</strong> ${data.recent_sensors?.length || 0} readings<br>
                <strong>Quality Score:</strong> ${data.plant_overview?.quality_score_avg || 'N/A'}%<br>
                <hr>
                <details>
                    <summary>Full Data (Click to expand)</summary>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                </details>
            `;
        }

        function displaySensorData(data) {
            log(`Sensor data contains ${data.length} readings`, 'info');
            data.forEach((reading, index) => {
                if (index < 3) { // Show first 3 readings
                    log(`  ${reading.sensor_id}: ${reading.value} ${reading.unit}`, 'info');
                }
            });
        }

        function displayProcessData(data) {
            log('Process Parameters:', 'info');
            log(`  Kiln Temperature: ${data.kiln_temperature}¬∞C`, 'info');
            log(`  Production Rate: ${data.production_rate} TPH`, 'info');
            log(`  Energy Consumption: ${data.energy_consumption} kWh/t`, 'info');
        }

        function clearLog() {
            document.getElementById('log').textContent = 'Log cleared...\n\n';
        }

        // Auto-connect on page load (optional)
        // window.onload = () => setTimeout(connect, 1000);

        log('Test client loaded. Click Connect to start testing.', 'success');
        log('Server URL is pre-filled with your deployed backend.', 'info');
    </script>
</body>
</html>